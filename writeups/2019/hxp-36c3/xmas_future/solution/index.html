<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>xmas present brought to you by hxp 36C3 CTF</title>

    <style>
      body {
        background: #0d0208;
        color: #eee;
        font-family: 'Open Sans', 'Arial';
        margin: 0;
      }
      h1 {
        margin-bottom: 0;
      }
      img {
        vertical-align: middle;
        height: 20px;
      }
      input {
        border: 3px solid #008f11;
        outline: none;
        border-radius: 15px;
        background-color: #eee;
        height: 30px;
        font-size: 20px;
        padding: 5px;
        text-align: center;
      }
      button {
        margin-top: 10px;
        border: 3px solid #008f11;
        border-radius: 10px;
        background-color: #0d0208;
        color: #00ff41;
        outline: none;
        padding: 7px 15px;
        font-size: 20px;
      }
      canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
      }
      #container {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #inner-container {
        display: flex;
        text-align: center;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 50px;
        background-image: radial-gradient(
          ellipse closest-side at center,
          rgba(0, 0, 0, 0.8) 60%,
          transparent 100%
        );
      }
    </style>
  </head>
  <body>
    <canvas id="canvas1"></canvas>
    <canvas id="canvas2"></canvas>

    <div id="container">
      <div id="inner-container">
        <h1>High-speed flag checking</h1>
        <h3>Powered by Rust <img src="./ferris.svg" /> and WASM <img src="./wasm.svg" /></h3>

        <form id="form">
          <input type="text" id="flag" placeholder="hxp{...}" size="60" /><br />
          <button type="button" id="solveBtn">Solve</button>
          <button type="button" id="guessBtn">Guess</button>
          <button type="submit">Check</button>
        </form>
      </div>
    </div>

    <!-- Generated by running wasabi on hxp2019_bg.wasm -->
    <script src="./hxp2019_bg.wasabi.js"></script>

    <!--  From Wasabi's example analyses dir: https://github.com/danleh/wasabi/blob/master/analyses/instruction-count.js -->
    <script src="./instruction-count.js"></script>

    <script type="module">
      import init, { check } from './hxp2019.js';

      const alphabet = 'abcdefghijklmnopqrstuvwxyz0123456789_-./'.split('');
      const prefix = 'hxp{';
      const suffix = '}';
      const padLen = 50 - prefix.length - suffix.length;
      const maxGuessCursor = 50 - suffix.length;
      window.guessCursor = prefix.length;

      /**
      * Sets up the side channel counters and guesses the flag character-by-character
      */
      function doSolve(e) {
          const flag = document.getElementById('flag').value;

          // Set the baseline instruction count by checking the placeholder a couple times until it stabilizes.
	  check(flag);
	  clearCounts();
	  check(flag);
	  // The instruction count should be stable now. Let's record this sum and start guessing char-by-char.
	  recordSum();

	  for (var pos = window.guessCursor; pos < maxGuessCursor; pos++) {
	      doGuess();
	  }

      }

      /**
      * Guesses the char located at guessCursor
      */
      function doGuess(e) {
          const lastguess = document.getElementById('flag').value;
          const guessCursor = window.guessCursor || 0;

	  if (guessCursor >= maxGuessCursor) {
	      console.log('Guess cursor is at the end of the flag. Skipping guess process.')
	      return;
	  }

	  const preguess_count = window.sum || 0;
	  console.log('Pre-guess count:  ' + preguess_count)
	  for (var c of alphabet) {
	      // Replace the character at guessCursor with our guess
	      var guessArr = lastguess.split('');
	      guessArr[guessCursor] = c;
	      const guess = guessArr.join('');

              // Check our guess and record the number of instructions run.
	      // If the count goes up, then we've found another letter.
	      clearCounts();
	      check(guess);
	      const postguess_count = recordSum();
	      if (postguess_count > preguess_count) {
	          // Found another letter
	          console.log("Post-guess count: " + postguess_count);
		  console.log('Found a character: ' + c)
		  console.log("Updated guess: " + guess)
		  document.getElementById('flag').value = guess;
		  window.guessCursor = guessCursor + 1;
		  return;
	      }
	  }
      }

      /**
      * Slightly-modified doCheck method from the original challenge
      */
      function doCheck(e) {
          e.preventDefault();
          const flag = document.getElementById('flag').value;

	  clearCounts();

          if (check(flag)) {
            alert('Yes, you found the flag!');
          } else {
            alert('Nope.');
          }

	  const count = recordSum();
	  clearCounts();

	  console.log("Post-check count: " + count);
      }

      function recordSum() {
	  var sum = 0
	  for (var key in counts) {
	      sum += counts[key];
	  }
	  window.sum = sum;
	  return sum;
      }

      function clearCounts() {
	  for (var key in counts) {
	      counts[key] = 0;
	  }
      }

      async function run() {
        await init();

        document.getElementById('form').addEventListener('submit', doCheck);
        document.getElementById('guessBtn').addEventListener('click', doGuess);
        document.getElementById('solveBtn').addEventListener('click', doSolve);
        document.getElementById('flag').value = prefix + '#'.repeat(padLen) + suffix;
      }

      run();
    </script>
  </body>
</html>
